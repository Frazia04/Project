--ALTER TABLE uploads DROP PRIMARY KEY;
--ALTER TABLE uploads ADD id INT NOT NULL AUTO_INCREMENT PRIMARY KEY FIRST;

CREATE TABLE uploads2
(
    id                 INT          NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    exercise           VARCHAR(50)  NOT NULL,
    sheet              VARCHAR(50)  NOT NULL,
    team               VARCHAR(200) NOT NULL,
    assignment         VARCHAR(50)  NOT NULL,
    filename           VARCHAR(200) NOT NULL,
    upload_date        TIMESTAMP    NOT NULL,
    uploader_studentid VARCHAR(50)  NULL, -- null for backwards compatibility
    delete_date        TIMESTAMP    NULL,
    deleter_studentid  VARCHAR(50)  NULL,

    FOREIGN KEY (sheet, exercise) REFERENCES sheets (id, exercise),
    FOREIGN KEY (assignment, exercise, sheet) REFERENCES assignments (id, exercise, sheet)
);

INSERT INTO uploads2 (exercise, sheet, team, assignment, filename, upload_date, uploader_studentid, delete_date, deleter_studentid)
SELECT                exercise, sheet, team, assignment, filename, upload_date, uploader_studentid, delete_date, deleter_studentid
FROM uploads;

DROP TABLE uploads;
ALTER TABLE uploads2 RENAME TO uploads;


--ALTER TABLE annotations DROP PRIMARY KEY;
--ALTER TABLE annotations ADD fileid INT NULL DEFAULT NULL FIRST;

CREATE TABLE annotations2
(
    fileid        INT NULL DEFAULT NULL,
    exercise      VARCHAR(50),
    sheet         VARCHAR(50),
    assignment    VARCHAR(50),
    team          VARCHAR(200),
    filename      VARCHAR(256),
    line          INT,
    annotationObj VARCHAR,

    FOREIGN KEY (sheet, exercise) REFERENCES sheets(id, exercise),
    FOREIGN KEY (assignment, exercise, sheet) REFERENCES assignments(id,exercise,sheet)
);

INSERT INTO annotations2 (fileid,   exercise,   sheet,   assignment,   team,   filename,   line,   annotationObj)
SELECT                    u.id,   a.exercise, a.sheet, a.assignment, a.team, a.filename, a.line, a.annotationObj
FROM annotations AS a
LEFT JOIN uploads AS u
    ON  a.exercise   = u.exercise
    AND a.sheet      = u.sheet
    AND a.assignment = u.assignment
    AND a.team       = u.team
    AND a.filename   = CONCAT(TO_CHAR(u.upload_date, 'YYYYMMDDHH24MISS'), '-', u.filename);

DROP TABLE annotations;

CREATE TABLE illegal_annotations AS SELECT * FROM annotations2 a WHERE a.fileid IS NULL;
DELETE FROM annotations2 WHERE fileid IS NULL;


-- ALTER TABLE annotations ALTER COLUMN fileid SET NOT NULL;
-- ALTER TABLE annotations ALTER COLUMN line SET NOT NULL;
-- ALTER TABLE annotations DROP COLUMN exercise, sheet, assignment, team, filename;
-- ALTER TABLE annotations ADD PRIMARY KEY (fileid, line);
-- ALTER TABLE annotations ADD FOREIGN KEY (fileid) REFERENCES uploads(id);

CREATE TABLE annotations
(
    fileid        INT NOT NULL,
    line          INT NOT NULL,
    annotationObj VARCHAR,

    PRIMARY KEY (fileid, line),
    FOREIGN KEY (fileid) REFERENCES uploads(id)
);

INSERT INTO annotations (fileid, line, annotationObj)
SELECT                   fileid, line, annotationObj
FROM annotations2;

DROP TABLE annotations2;
